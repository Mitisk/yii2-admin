document.addEventListener("DOMContentLoaded",function(){const csrf=$('meta[name="csrf-token"]').attr("content");const $btn=$(".js-get-api-key");if($btn.length){$btn.on("click",async function(e){e.preventDefault();const domain=window.location.hostname;try{const data=await $.ajax({url:"https://api.keypage.ru/mitisk/api/get.php",method:"POST",contentType:"application/json",data:JSON.stringify({domain:domain}),dataType:"json"});if(!data.api_key){alert("Ошибка: не удалось получить API ключ");return}const saveResult=await $.ajax({url:window.adminConfig.urls.saveApi,method:"POST",contentType:"application/json",headers:{"X-CSRF-Token":csrf},data:JSON.stringify({api_key:data.api_key}),dataType:"json"});if(saveResult.success){$(".js-success").removeClass("hidden");$(".js-error-api").addClass("hidden")}else{alert("Ошибка при сохранении API ключа")}}catch(error){console.error(error);alert("Ошибка запроса или сохранения API ключа")}})}var maxEmails=5;var emailSelector=".js-add-email";function updateButtons(){var fields=$(emailSelector);var count=fields.length;fields.each(function(index){var addBtn=$(this).find(".js-add-more");var removeBtn=$(this).find(".remove-email");if(count>=maxEmails){addBtn.hide();removeBtn.show()}else{if(index===count-1){addBtn.show();removeBtn.hide()}else{addBtn.hide();removeBtn.show()}}})}$(document).on("click",".js-add-more",function(e){e.preventDefault();var count=$(emailSelector).length;if(count>=maxEmails)return;var lastField=$(emailSelector).last();var newField=lastField.clone();newField.find('input[type="email"]').val("");lastField.after(newField);updateButtons()});$(document).on("click",".remove-email",function(e){e.preventDefault();if($(emailSelector).length>1){$(this).closest(emailSelector).remove();updateButtons()}});updateButtons();var selectElement=document.getElementById("timezone-select");if(selectElement){var timezones=moment.tz.names();var docFrag=document.createDocumentFragment();timezones.forEach(function(zone){var option=document.createElement("option");option.value=zone;option.textContent=zone;docFrag.appendChild(option)});selectElement.appendChild(docFrag);if(selectedTimezone&&timezones.includes(selectedTimezone)){selectElement.value=selectedTimezone}else{var guessed=moment.tz.guess();if(guessed&&timezones.includes(guessed)){selectElement.value=guessed}}new TomSelect(selectElement,{create:false,sortField:{field:"text",direction:"asc"},plugins:["dropdown_input"],maxOptions:null})}$(document).on("click",".js-copy-settings",function(){var $this=$(this);var textToCopy=$this.data("copy");if(navigator.clipboard&&window.isSecureContext){navigator.clipboard.writeText(textToCopy).then(function(){showTooltipMessage($this,"Скопировано!")}).catch(function(err){console.error("Не удалось скопировать: ",err);fallbackCopyTextToClipboard(textToCopy,$this)})}else{fallbackCopyTextToClipboard(textToCopy,$this)}});function fallbackCopyTextToClipboard(text,$element){var textArea=document.createElement("textarea");textArea.value=text;textArea.style.position="fixed";textArea.style.left="-9999px";textArea.style.top="0";document.body.appendChild(textArea);textArea.focus();textArea.select();try{var successful=document.execCommand("copy");if(successful){showTooltipMessage($element,"Скопировано!")}else{showTooltipMessage($element,"Ошибка копирования")}}catch(err){console.error("Fallback: Ошибка копирования",err)}document.body.removeChild(textArea)}function showTooltipMessage($element,message){var originalTitle=$element.attr("title");$element.attr("title",message);$element.fadeOut(200).fadeIn(200);setTimeout(function(){$element.attr("title",originalTitle)},2e3)}const saveUrl=window.adminConfig.urls.updateSectionName;$(document).on("click",".js-change-header h5",function(){const $wrap=$(this).closest(".js-change-header");const $h5=$wrap.find("h5");const $input=$wrap.find('input[type="text"]');const origin=$.trim($h5.text());$input.val(origin).data("origin",origin);$h5.hide();$input.show().focus();const el=$input.get(0),v=$input.val();el?.setSelectionRange?.(String(v).length,String(v).length)});$(document).on("click",".js-change-header .body-text",function(){const $wrap=$(this).closest(".js-change-header");const $view=$wrap.find(".body-text");const $ta=$wrap.find("textarea");const origin=$ta.val()!==undefined&&$ta.val()!==null?String($ta.val()):$.trim($view.text());$ta.val(origin).data("origin",origin);$view.hide();$ta.show().focus()});function persistTitle($wrap,newVal){const key=$wrap.find('input[type="text"]').attr("name").replace(/^names\[/,"").replace(/\]$/,"");return $.ajax({url:saveUrl,type:"POST",dataType:"json",data:{key:key,value:newVal,_csrf:csrf,type:"title"}})}function persistDesc($wrap,newVal){const key=$wrap.find("textarea").attr("name").replace(/^description\[/,"").replace(/\]$/,"");return $.ajax({url:saveUrl,type:"POST",dataType:"json",data:{key:key,value:newVal,_csrf:csrf,type:"description"}})}function commitTitle($wrap){const $h5=$wrap.find("h5");const $input=$wrap.find('input[type="text"]');const origin=String($input.data("origin")??"");const newVal=$.trim(String($input.val()??""));if(!newVal.length){$input.val(origin);$h5.text(origin);$input.hide();$h5.show();return}if(newVal===origin){$input.hide();$h5.show();return}$h5.text(newVal);$input.hide();$h5.show();persistTitle($wrap,newVal).then(function(res){if(!res||res.ok!==true)throw new Error(res&&res.error||"Save failed");const serverVal=res.value||newVal;$h5.text(serverVal);$wrap.find('input[type="text"]').val(serverVal)}).catch(function(e){$h5.text(origin);$wrap.find('input[type="text"]').val(origin);console.error(e&&e.message?e.message:e)})}function commitDesc($wrap){const $view=$wrap.find(".body-text");const $ta=$wrap.find("textarea");const origin=String($ta.data("origin")??"");const newVal=String($ta.val()??"");if(newVal===origin){$ta.hide();$view.show();return}const displayVal=newVal.length?newVal:"—";$view.text(displayVal);$ta.hide();$view.show();persistDesc($wrap,newVal).then(function(res){if(!res||res.ok!==true)throw new Error(res&&res.error||"Save failed");const serverVal=res.value!==undefined?String(res.value):newVal;$wrap.find("textarea").val(serverVal);$view.text(serverVal.length?serverVal:"—")}).catch(function(e){$wrap.find("textarea").val(origin);$view.text(origin.length?origin:"—");console.error(e&&e.message?e.message:e)})}$(document).on("mousedown",function(e){$(".js-change-header").each(function(){const $wrap=$(this);const $input=$wrap.find('input[type="text"]');if($input.is(":visible")){const clickInside=$(e.target).closest($wrap).length>0;if(!clickInside)commitTitle($wrap)}const $ta=$wrap.find("textarea");if($ta.is(":visible")){const clickInside=$(e.target).closest($wrap).length>0;if(!clickInside)commitDesc($wrap)}})});$(document).on("keydown",'.js-change-header input[type="text"]',function(e){const $wrap=$(this).closest(".js-change-header");if(e.key==="Enter"){e.preventDefault();commitTitle($wrap)}else if(e.key==="Escape"){const origin=String($(this).data("origin")??"");$(this).val(origin).hide();$wrap.find("h5").text(origin).show()}});$(document).on("keydown",".js-change-header textarea",function(e){const $wrap=$(this).closest(".js-change-header");if(e.key==="Enter"&&(e.ctrlKey||e.metaKey)){e.preventDefault();commitDesc($wrap)}else if(e.key==="Escape"){const origin=String($(this).data("origin")??"");$(this).val(origin).hide();$wrap.find(".body-text").text(origin.length?origin:"—").show()}});$(document).on("blur",'.js-change-header input[type="text"]',function(){commitTitle($(this).closest(".js-change-header"))});$(document).on("blur",".js-change-header textarea",function(){commitDesc($(this).closest(".js-change-header"))})});