document.addEventListener("DOMContentLoaded",function(){let sortableInstance=null;function initSortable(){const container=document.querySelector(".dashboard-top-widget-section");if(!container)return;if(sortableInstance){sortableInstance.destroy()}sortableInstance=new Sortable(container,{draggable:".dashboard-top-widget-item",handle:".dashboard-top-widget-item-move",animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",filter:".dashboard-add-top-widget-section",preventOnFilter:false,onEnd:function(evt){if(evt.oldIndex!==evt.newIndex){updateWidgetOrder()}},onStart:function(evt){console.log("Начато перетаскивание:",evt.item.dataset.name)},onUpdate:function(evt){console.log("Позиция изменена с",evt.oldIndex,"на",evt.newIndex)}})}initSortable();document.addEventListener("click",function(e){if(e.target.closest(".dashboard-add-top-widget-section")){e.preventDefault();const modal=document.getElementById("addWidgetModal");if(modal){const bootstrapModal=new bootstrap.Modal(modal);bootstrapModal.show()}}});const addWidgetBtn=document.getElementById("addWidgetBtn");if(addWidgetBtn){addWidgetBtn.addEventListener("click",function(){const widgetClassInput=document.getElementById("widgetClass");const widgetClass=widgetClassInput.value.trim();if(!widgetClass){showError("Укажите класс виджета");return}addWidget(widgetClass)})}document.addEventListener("click",function(e){if(e.target.closest(".dashboard-top-widget-item-hide")){e.preventDefault();const item=e.target.closest(".dashboard-top-widget-item");const alias=item.dataset.name;if(confirm("Вы уверены, что хотите скрыть этот виджет?")){hideWidget(alias,item)}}});function addWidget(widgetClass){const formData=new FormData;formData.append("class",widgetClass);formData.append("_csrf",document.querySelector("meta[name=csrf-token]").getAttribute("content"));const addBtn=document.getElementById("addWidgetBtn");addBtn.disabled=true;addBtn.textContent="Добавление...";hideAlerts();fetch("/admin/ajax-widget/add/",{method:"POST",body:formData}).then(response=>response.json()).then(data=>{if(data.success){const tempDiv=document.createElement("div");tempDiv.innerHTML=data.html;const newWidget=tempDiv.firstElementChild;const addButton=document.querySelector(".dashboard-add-top-widget-section");addButton.parentNode.insertBefore(newWidget,addButton);initSortable();const modal=bootstrap.Modal.getInstance(document.getElementById("addWidgetModal"));modal.hide();document.getElementById("addWidgetForm").reset();showSuccess(data.message)}else{showError(data.message)}}).catch(error=>{console.error("Ошибка:",error);showError("Произошла ошибка при добавлении виджета")}).finally(()=>{addBtn.disabled=false;addBtn.textContent="Добавить"})}function updateWidgetOrder(){const widgets=document.querySelectorAll(".dashboard-top-widget-item");const aliases=Array.from(widgets).map(widget=>widget.dataset.name).filter(name=>name);if(aliases.length===0)return;const formData=new FormData;formData.append("aliases",JSON.stringify(aliases));formData.append("_csrf",document.querySelector("meta[name=csrf-token]").getAttribute("content"));fetch("/admin/ajax-widget/update-order/",{method:"POST",body:formData}).then(response=>response.json()).then(data=>{if(!data.success){console.error("Ошибка обновления порядка:",data.message);showToast("error","Ошибка сохранения порядка")}else{showToast("success","Порядок виджетов обновлен")}}).catch(error=>{console.error("Ошибка AJAX запроса:",error);showToast("error","Ошибка соединения")})}function hideWidget(alias,item){const formData=new FormData;formData.append("alias",alias);formData.append("_csrf",document.querySelector("meta[name=csrf-token]").getAttribute("content"));fetch("/admin/ajax-widget/hide/",{method:"POST",body:formData}).then(response=>response.json()).then(data=>{if(data.success){item.style.transition="all 0.3s ease";item.style.opacity="0";item.style.transform="translateX(-100%)";setTimeout(()=>{item.remove();initSortable()},300);showToast("success","Виджет скрыт")}else{alert("Ошибка: "+data.message)}}).catch(error=>{console.error("Ошибка:",error);alert("Произошла ошибка при скрытии виджета")})}function showError(message){const successAlert=document.getElementById("widgetSuccess");const errorAlert=document.getElementById("widgetError");if(successAlert)successAlert.classList.add("d-none");if(errorAlert){errorAlert.classList.remove("d-none");errorAlert.textContent=message}}function showSuccess(message){const successAlert=document.getElementById("widgetSuccess");const errorAlert=document.getElementById("widgetError");if(errorAlert)errorAlert.classList.add("d-none");if(successAlert){successAlert.classList.remove("d-none");successAlert.textContent=message}}function hideAlerts(){const alerts=document.querySelectorAll("#widgetError, #widgetSuccess");alerts.forEach(alert=>alert.classList.add("d-none"))}function showToast(type,message){const toast=document.createElement("div");toast.className=`alert alert-${type==="success"?"success":"danger"} position-fixed`;toast.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 300px;";toast.textContent=message;document.body.appendChild(toast);setTimeout(()=>{toast.style.transition="opacity 0.3s ease";toast.style.opacity="0";setTimeout(()=>toast.remove(),300)},3e3)}$(document).on("click",".dashboard-add-center-widget-section",function(e){e.preventDefault();const $block=$(this);$.get("/admin/ajax-widget/component-popup/",function(html){const $modal=$(html);$("body").append($modal);const modalEl=$modal.get(0);const modal=new bootstrap.Modal(modalEl,{backdrop:true,keyboard:true});modal.show();$modal.on("click","#component-picker-apply",function(){const alias=$modal.find("#component-select").val();if(!alias){alert("Выберите компонент");return}$.ajax({url:"/admin/ajax-widget/save-component/",method:"POST",data:{alias:alias,_csrf:yii.getCsrfToken()},dataType:"json"}).done(function(resp){if(resp.success){$block.replaceWith(resp.html);$modal.modal("hide")}else{alert(resp.message||"Ошибка")}}).fail(function(){alert("Сетевой сбой")})});$modal.on("click","#component-picker-cancel, #component-picker-close",function(){$modal.modal("hide")});$modal.on("hidden.bs.modal",function(){$modal.remove()})})})});(function($){$.ajaxSetup({headers:{"X-CSRF-Token":$('meta[name="csrf-token"]').attr("content")}});const $editorEl=$("#text-meta");const $saveBtn=$(".tf-button.w-full.style-2");$editorEl.trumbowyg({lang:"ru",imageWidthModalEdit:true,autogrow:true,btns:[["removeformat"],["justifyLeft","justifyCenter","justifyRight","justifyFull"],["unorderedList","orderedList"],["table"],["emoji"],["link","insertImage"],["formatting"],["strong","em","del"],["horizontalRule"],["viewHTML"]]});let saveTimer=null;let isSaving=false;let lastSent="";let dirty=false;function setEditorHtml(html){$editorEl.trumbowyg("html",html||"")}function getEditorHtml(){return $editorEl.trumbowyg("html")}function showSaveBtn(){$saveBtn.stop(true,true).fadeIn(120)}function hideSaveBtn(){$saveBtn.stop(true,true).fadeOut(120)}function markDirty(){const current=getEditorHtml();dirty=current!==lastSent;if(dirty)showSaveBtn();else hideSaveBtn()}function scheduleAutoSave(){if(saveTimer)clearTimeout(saveTimer);saveTimer=setTimeout(saveNote,1e4)}function loadNote(){$.get("/admin/ajax-note/get/").done(function(res){if(res&&res.ok){setEditorHtml(res.text||"");lastSent=String(res.text||"");dirty=false;hideSaveBtn()}})}function saveNote(){if(isSaving)return;const html=getEditorHtml();if(html===lastSent){dirty=false;hideSaveBtn();return}isSaving=true;$saveBtn.prop("disabled",true);$.ajax({url:"/admin/ajax-note/save/",method:"POST",data:{text:html}}).done(function(res){if(res&&res.ok){lastSent=html;dirty=false;hideSaveBtn()}else{dirty=true;showSaveBtn();console.warn("Save failed",res&&res.errors)}}).fail(function(xhr){dirty=true;showSaveBtn();console.error("Save error",xhr.status)}).always(function(){isSaving=false;$saveBtn.prop("disabled",false)})}$editorEl.on("tbwchange tbwpaste",function(){markDirty();scheduleAutoSave()});$saveBtn.on("click",function(e){e.preventDefault();saveNote()});window.addEventListener("beforeunload",function(){const html=getEditorHtml();if(html!==lastSent&&!isSaving){const token=$('meta[name="csrf-token"]').attr("content");const body=new URLSearchParams({text:html});if(token)body.append("_csrf",token);navigator.sendBeacon("/admin/ajax-note/save/",body)}});loadNote()})(jQuery);